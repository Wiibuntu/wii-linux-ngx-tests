--- mm/swapfile.c
+++ mm/swapfile.c
@@ -677,6 +677,8 @@ start_over:
 			return swp_entry(si->type, offset);
 		pr_debug("scan_swap_map of si %d failed to find offset\n",
 		       si->type);
+		cond_resched();
+
 		spin_lock(&swap_avail_lock);
 nextsi:
 		/*
@@ -2254,6 +2285,8 @@ static unsigned long read_swap_header(struct swap_info_struct *p,
 		swab32s(&swap_header->info.version);
 		swab32s(&swap_header->info.last_page);
 		swab32s(&swap_header->info.nr_badpages);
+		if (swap_header->info.nr_badpages > MAX_SWAP_BADPAGES)
+			return 0;
 		for (i = 0; i < swap_header->info.nr_badpages; i++)
 			swab32s(&swap_header->info.badpages[i]);
 	}
